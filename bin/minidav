#!/bin/sh -e
#L:
#L:  MIT License
#L:  
#l:  Bug reports, feature requests to gemini|https://harkadev.com/oss
#l:  Copyright (c) 2022 Harkaitz Agirre, harkaitz.aguirre@gmail.com
#L:
#L:  Permission is hereby granted, free of charge, to any person obtaining
#L:  a copy of this software and associated documentation files (the
#L:  "Software"), to deal in the Software without restriction, including
#L:  without limitation the rights to use, copy, modify, merge, publish,
#L:  distribute, sublicense, and/or sell copies of the Software, and to
#L:  permit persons to whom the Software is furnished to do so, subject to
#L:  the following conditions:
#L:
#L:  The above copyright notice and this permission notice shall be
#L:  included in all copies or substantial portions of the Software.
#L:
#L:  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#L:  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#L:  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#L:  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#L:  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#L:  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#L:  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
##:
##: Documentation abour rclone:
##: - https://rclone.org/commands/rclone_serve_webdav/
##:
#h: Usage: $0 ...
#h:
#h: Install `rclone` powered `webdav` service in `Void Linux`.
#h:
#h: show                             : Show configuration.
#h: create  NAME USER PORT DIRECTORY : Install dav service.
#h: enable  NAME                     : Enable dav service.
#h: disable NAME                     : Disable dav service
#h: manage  NAME                     : Open interactive manager.
. hmain
. vrun
. hlog
. hpkg
. hfile
minidav() {
    local cmd="$1"
    shift
    case "${cmd}" in
        show)    minidav_show_variables ;;
        create)  minidav_create  "$@"   ;;
        enable)  minidav_enable  "$@"   ;;
        disable) minidav_disable "$@"   ;;
        manage)  minidav_manage  "$@"   ;;
        *)       hlog fatal "Invalid argument: ${cmd}." ;;
    esac
}
minidav_create() {
    local name="$1" user="$2" port="$3" dir="$4"
    hlog errif "Please specify a service name." test ! -n "${name}"
    hlog errif "Please specify a username."     test ! -n "${user}"
    hlog errif "Please specify a port."         test ! -n "${port}"
    hlog errif "Please specify a directory."    test ! -n "${dir}"
    local uid="`id -u "${user}"`"; test -n "${uid}"
    vrun hpkg -w "rclone" -w "htpasswd" -i %xbps "rclone" "apache-htpasswd"
    vrun sudo touch "/etc/${name}.htpasswd"
    vrun sudo mkdir -p "/etc/sv/${name}"
    vrun hfile wrapper sudo "/etc/sv/${name}/run" <<-EOF
	#!/bin/sh
	set -e
	exec rclone serve webdav                  \\
	    --htpasswd    "/etc/${name}.htpasswd" \\
	    --addr        "127.0.0.1:${port}"     \\
	    --uid         "${uid}"                \\
	    --copy-links                          \\
	    "${dir}"
	EOF
}
minidav_enable() {
    local name="$1"
    hlog errif "Please specify a service name." test ! -n "${name}"
    if test -e "/etc/runit/runsvdir/default/${name}";then
        vrun sudo sv restart "${name}"
    elif test ! -e "/etc/sv/${name}";then
        hlog fatal "Not installed."
    else
        vrun sudo ln -s "/etc/sv/${name}" "/etc/runit/runsvdir/default/${name}"
    fi
}
minidav_disable() {
    local name="$1"
    hlog errif "Please specify a service name." test ! -n "${name}"
    if test -e /etc/runit/runsvdir/default/"${name}";then
        vrun sudo sv down "${name}" || true
        vrun sudo rm /etc/runit/runsvdir/default/"${name}"
    fi
}
minidav_manage() {
    local line= username= name="$1"
    hlog errif "Please specify a service name." test ! -n "${name}"
    echo "**************************"
    echo "* WEBDAV SERVICE OPTIONS *"
    echo "**************************"    
    while true;do
        echo    ""
        echo    "1.- Add new user."
        echo    "2.- List users."
        echo    "q.- Done."
        echo -n "> "
        read line
        case "$line" in
            1)  echo -n "Username> "; read username
                sudo htpasswd -B "/etc/${name}.htpasswd" "${username}"
                ;;
            2)  sudo sed 's|:.*||' "/etc/${name}.htpasswd"
                ;;
            q)
                break
                ;;
        esac
    done
}
## -----------------------------------------------------------------------------
hmain -f "minidav" minidav "$@"
