#!/bin/sh -e
#L:
#L:  MIT License
#L:  
#l:  Bug reports, feature requests to gemini|https://harkadev.com/oss
#l:  Copyright (c) 2022 Harkaitz Agirre, harkaitz.aguirre@gmail.com
#L:
#L:  Permission is hereby granted, free of charge, to any person obtaining
#L:  a copy of this software and associated documentation files (the
#L:  "Software"), to deal in the Software without restriction, including
#L:  without limitation the rights to use, copy, modify, merge, publish,
#L:  distribute, sublicense, and/or sell copies of the Software, and to
#L:  permit persons to whom the Software is furnished to do so, subject to
#L:  the following conditions:
#L:
#L:  The above copyright notice and this permission notice shall be
#L:  included in all copies or substantial portions of the Software.
#L:
#L:  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#L:  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#L:  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#L:  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#L:  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#L:  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#L:  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
##:
#h: Usage: $0 ...
#h:
#h: My window manager and terminal configuration for Void Linux and Xorg.
#h:
#h: Config files:
#h:
#h:     /etc/xsetup.sh    : This is executed by `x-setup-screen`.
#h:     ~/.background.png : Background image.
#h:     /etc/xapplets.sh  : This is executed by `x-setup-applets`.
#h:
#h: Operations:
#h:
#h:     xorg-server          : Install Xorg server, screen light managers.
#h:     xorg-client          : Install Xorg client software.
#h:     scripts              : Install all x-* scripts below.
#h:     x-terminal-emulator  :
#h:     x-refresh-background :
#h:     x-setup-screen       :
#h:     x-setup-applets      :
#h:     i3-install           : Install I3.
#h:     i3-xinit             : Configure ~/.xinitrc to run I3.
. hlog
. hpkg
. vrun
. hfile
. hmain
hvoid_wm() {
    local cmd="$1"
    shift
    case "${cmd}" in
        xorg-server)          hvoid_wm_xorg_server          ;;
        xorg-client)          hvoid_wm_xorg_client          ;;
        scripts)              hvoid_wm_x_terminal_emulator
                              hvoid_wm_x_refresh_background
                              hvoid_wm_x_setup_screen
                              hvoid_wm_x_setup_applets      ;;
        x-terminal-emulator)  hvoid_wm_x_terminal_emulator  ;;
        x-refresh-background) hvoid_wm_x_refresh_background ;;
        x-setup-screen)       hvoid_wm_x_setup_screen       ;;
        x-setup-applets)      hvoid_wm_x_setup_applets      ;;
        i3-install)           hvoid_wm_i3_install           ;;
        i3-xinit)             hvoid_wm_i3_xinit             ;;
        *)                    hlog fatal "Invalid argument: ${cmd}." ;;
    esac
}
## -----------------------------------------------------------------------------
hvoid_wm_xorg_server() {
    hlog info "Installing 'Xorg server' ..."
    hpkg -vi -w "/bin/Xorg" %xbps "xorg-minimal" "xorg-fonts"
    hpkg -vi -w "/usr/share/kbd/consolefonts/ERRORS" %xbps "kbd-data"
}
hvoid_wm_xorg_client() {
    hlog info "Installing basic 'Xorg utilities' ..."
    hpkg -vi \
         -w "xrandr"  -w "setxkbmap"  -w "xrdb"     -w "xprop" `: Configuration`   \
         -w "xterm"   -w "xclip"      -w "xmessage" -w "dmenu" `: Basic utilities` \
         -w "dunst"   -w "pinentry-dmenu"                                          \
         -w "xdotool" -w "xprintidle" -w "wmctrl"         `: Scripting`            \
         -w "glxinfo"                                     `: Graphics`             \
         -w "xgamma"  -w "xbacklight" -w "brightnessctl"  `: Screen light`         \
         -w "feh"     -w "nsxiv"      -w "nomacs"         `: Image viewers`        \
         -w "emacs"                                       `: Text editors.`        \
         -w "pcmanfm" -w "xarchiver"                      `: Explorer, archiver`   \
         -w "mplayer" -w "ffmpeg" -w "vlc"                `: Multimedia`           \
         -w "wine"                                        `: Windows compat`       \
         %xbps                                                                     \
         xrandr setxkbmap xrdb xprop                     \
         xterm xclip xmessage dmenu dunst pinentry-dmenu \
         xdotool xprintidle wmctrl                       \
         glxinfo                                         \
         xgamma xbacklight brightnessctl                 \
         feh nsxiv nomacs                                \
         emacs-x11                                       \
         pcmanfm xarchiver                               \
         mplayer ffmpeg vlc                              \
         wine wine-32bit wine-mono winetricks
    hlog info "Creating /etc/mplayer/mplayer.conf ..."
    hfile create sudo /etc/mplayer/mplayer.conf <<-EOF
	eo=alsa
	EOF
    hlog info "Creating /etc/profile.d/notify.sh ..."
    hfile wrapper sudo /etc/profile.d/notify.sh <<-EOF
	if test ! -n "\${DBUS_SESSION_BUS_ADDRESS}" && test -f ~/.dbus-session.txt;then
	    export DBUS_SESSION_BUS_ADDRESS="`cat ~/.dbus-session.txt`"
	fi
	EOF
}
hvoid_wm_x_terminal_emulator() {
    #: ## i3
    #:
    #: "i3" when launching a terminal calls "i3-sensible-terminal".
    #: "i3-sensible-terminal" tries to find one, the first try
    #: is "x-terminal-emulator".
    #:
    hlog info "Creating /usr/bin/x-terminal-emulator ..."
    hfile wrapper sudo "/usr/bin/x-terminal-emulator" <<-EOF
	#!/bin/sh -e
	if which st >/dev/null 2>&1;then
	    exec st -e bash -l "\$@"
	else
	    exec xterm        \\
	        -fg white     \\
	        -bg black     \\
	        -fa Monospace \\
	        -fs 12        \\
	        -e bash -l "\$@"
	fi
	EOF
}
hvoid_wm_x_refresh_background() {
    hlog info "Creating /usr/bin/x-refresh-background ..."
    hfile wrapper sudo "/usr/bin/x-refresh-background" <<-EOF
	#!/bin/sh -e
	if test ! -f ~/.background.png;then
	    echo 'File ~/.background.png does not exist.' >&2
	    exit 0
	fi
	if test -n "\$1";then
	    sleep "\$1"
	fi
	feh --bg-scale ~/.background.png
	EOF
}
hvoid_wm_x_setup_screen() {
    hlog info "Creating /usr/bin/x-setup-screen ..."
    hfile wrapper sudo "/usr/bin/x-setup-screen" <<-EOF
	#!/bin/sh -e
	echo 'xterm*metaSendsEscape: true' >> ~/.Xdefaults
	xrdb -l ~/.Xdefaults
	test ! -f /etc/X11/xinit/.Xresources || xrdb -merge /etc/X11/xinit/.Xresources
	test ! -f /etc/X11/xinit/.Xmodmap    || xmodmap /etc/X11/xinit/.Xmodmap
	test ! -f ~/.Xresources || xrdb -merge ~/.Xresources
	test ! -f ~/.Xmodmap    || xmodmap ~/.Xmodmap
	if test -f /etc/xsetup.sh;then
	    . /etc/xsetup.sh || true
	fi
	EOF
}
hvoid_wm_x_setup_applets() {
    hlog info "Creating /usr/bin/x-setup-applets ..."
    hfile wrapper sudo "/usr/bin/x-setup-applets" <<-EOF
	#!/bin/sh -e
	if test -f /etc/xapplets.sh;then
	    if test -n "\$1";then
	        sleep "\$1"
	    fi
	    . /etc/xapplets.sh
	    wait
	fi
	EOF
}
hvoid_wm_i3_install() {
    hlog info "Installing I3 window manager ..."
    hpkg -vi -w "i3" -w "i3status" -w "feh" %xbps "i3" "i3status" "feh"
}
hvoid_wm_i3_xinit() {
    if test ! -f "/usr/bin/notify-send.bin";then
        hlog info "Disabling /usr/bin/notify-send ..."
        sudo mv "/usr/bin/notify-send" "/usr/bin/notify-send.bin"
    fi
    if true;then
        hlog "Configuring '~/.xinitrc' to launch I3 ..."
        hfile wrapper ~/.xinitrc <<-EOF
	#!/bin/sh -e
	{
	    pre= DBUS_SESSION_BUS_ADDRESS=
	    x-setup-screen || true
	    x-refresh-background 2 &
	    x-setup-applets      2 &
	    if which dbus-launch >/dev/null 2>&1;then
	        pre="\${pre} dbus-launch --sh-syntax --exit-with-session"
	    fi
	    \${pre} sh -c '
	        if test -n \${DBUS_SESSION_BUS_ADDRESS};then
	            echo "\${DBUS_SESSION_BUS_ADDRESS}" > ~/.dbus-session.txt
	        fi
	        i3' &
	    wait
	} > ~/.xinitrc.log 2>&1
	EOF
    fi
}
## -----------------------------------------------------------------------------
hmain -f "hvoid-wm" hvoid_wm "$@"
