#!/bin/sh -e
#L:
#L:  MIT License
#L:  
#l:  Bug reports, feature requests to gemini|https://harkadev.com/oss
#l:  Copyright (c) 2022 Harkaitz Agirre, harkaitz.aguirre@gmail.com
#L:
#L:  Permission is hereby granted, free of charge, to any person obtaining
#L:  a copy of this software and associated documentation files (the
#L:  "Software"), to deal in the Software without restriction, including
#L:  without limitation the rights to use, copy, modify, merge, publish,
#L:  distribute, sublicense, and/or sell copies of the Software, and to
#L:  permit persons to whom the Software is furnished to do so, subject to
#L:  the following conditions:
#L:
#L:  The above copyright notice and this permission notice shall be
#L:  included in all copies or substantial portions of the Software.
#L:
#L:  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#L:  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#L:  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#L:  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#L:  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#L:  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#L:  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
##:
#h: Usage: $0 ...
#h:
#h: Mount DAV filesystems as described in `/etc/hdav.csv` or
#h: ${HDAV_CONFIG} as "<DIR>,<URL>,<USER>,<PASS>".
#h:
#h: ... show           : Show configuration.
#h: ... install        : Install "davfs2" package.
#h: ... list|l         : List posible mounts.
#h: ... mount|m <DIR>  : Mount DAV remote directory.
#h: ... umount|u <DIR> : Unmount directory.
. hlog
. hpkg
. vrun
. hmain
. hterm
hdav() {
    local cmd="$1"
    shift
    case "${cmd}" in
        show)     hdav_show_variables                      ;;
        install)  hdav_install                             ;;
        list|l)   hdav_list                                ;;
        mount|m)  hdav_mount "$@"                          ;;
        umount|u) hdav_umount "$@"                         ;;
        *)        hlog fatal "Invalid subcommand: ${cmd}." ;;
    esac
}
hdav_show_variables() {
    hterm vars            \
          -               \
          HDAV_CONFIG     \
          HDAV_CONFIG_SYS \
          -
}
hdav_calc_variables() {
    HDAV_CONFIG="${HDAV_CONFIG:-}"
    HDAV_CONFIG_SYS="${HDAV_CONFIG_SYS:-/etc/hdav.csv}"
}
## -----------------------------------------------------------------------------
hdav_install() {
    hlog info 'Installing "davfs2" package ...'
    hpkg -vi -w "mount.davfs" %xbps "davfs2"
}
hdav_list() {
    hdav_list_csv | awk -F ',' '{printf "%-20s : %s\n",$1,$2}'
}
hdav_list_csv() {
    if true;then
        test ! -f "${HDAV_CONFIG}"     || cat "${HDAV_CONFIG}"
        test ! -f "${HDAV_CONFIG_SYS}" || cat "${HDAV_CONFIG_SYS}"
    fi | sed '/^ *$/d;s| *, *|,|g'
}
hdav_mount() {  # DIR
    local csv="`hdav_select "$@"`"; test -n "${csv}"
    local d="`printf '%s\n' "${csv}" | cut -d , -f 1`"
    local u="`printf '%s\n' "${csv}" | cut -d , -f 2`"
    local a="`printf '%s\n' "${csv}" | cut -d , -f 3`"
    local p="`printf '%s\n' "${csv}" | cut -d , -f 4`"
    hlog errif "${d}: The line hasn't an URL." test ! -n "${u}"
    if test ! -d "${d}";then
        vrun sudo mkdir -p "${d}"
    fi
    local o="rw,exec,gid=`id -g`,uid=`id -u`,grpid"
    if test -n "${a}";then
        local o="${o},username=${a}"
    fi
    printf '%s\n' "${p}" | vrun sudo mount -t davfs -o "${o}" "${u}" "${d}"
}
hdav_umount() { # DIR
    local name="$1"
    hlog errif "Please specify a directory." test ! -n "${name}"
    vrun sudo umount "${name}"
}
hdav_select() { # DIR
    local name="$1"
    hlog errif "Please specify a directory." test ! -n "${name}"
    local match="`hdav_list_csv | awk -v n="${name}" -F ',' '
    $1 == n {print; exit(0);}
    '`"
    hlog errif "Did't find ${name}." test ! -n "${match}"
    printf '%s\n' "${match}"
}



## -----------------------------------------------------------------------------
hdav_calc_variables
hmain -f "hdav" hdav "$@"
